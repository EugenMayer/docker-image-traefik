## see https://docs.traefik.io/reference/static-configuration/file/
<%
trusted_ips=[]
if env_TRAEFIK_TRUSTEDIPS != ""
  trusted_ips= env_TRAEFIK_TRUSTEDIPS.split(',').to_s
end

adminUsers=[]
if env_TRAEFIK_ADMIN_AUTH_USERS != ""
  adminUsers=env_TRAEFIK_ADMIN_AUTH_USERS.split('\n').to_s
end
%>

[global]
  sendAnonymousUsage = <%= env_TRAEFIK_USAGE_ENABLE %>
  checkNewVersion = false

[log]
  level = "<%= env_TRAEFIK_LOG_LEVEL %>"
  filePath = "<%= env_TRAEFIK_LOG_FILE %>"

[accessLog]
  filePath = "<%= env_TRAEFIK_ACCESS_FILE %>"

[serversTransport]
  insecureSkipVerify = <%= env_TRAEFIK_INSECURE_SKIP %>
  [serversTransport.forwardingTimeouts]
    dialTimeout = "<%= env_TRAEFIK_TIMEOUT_DIAL %>s"
    responseHeaderTimeout = "<%= env_TRAEFIK_TIMEOUT_HEADER %>s"

#########################  middlewares ##########################

<% if %w(true only).include?(env_TRAEFIK_HTTP_COMPRESSION) -%>
[http.middlewares]
  [http.middlewares.compress.compress]
<%- end -%>
<%- if adminUsers.length > 0 -%>
[http.middlewares.auth.basicAuth]
    users = <%= adminUsers %>
<%- end -%>
#########################  /middlewares/ ##########################

#########################  tls options ##########################

<%- if env_TRAEFIK_ADMIN_ENABLE == "true" || %w(true only).include?(env_TRAEFIK_HTTPS_ENABLE) -%>
<%- if env_TRAEFIK_ADMIN_SSL_CERT_FILE != "" -%>
[[tls.certificates]]
  certFile = "<%= env_TRAEFIK_ADMIN_SSL_CERT_FILE %>"
  keyFile = "<%= env_TRAEFIK_ADMIN_SSL_KEY_FILE %>"
<%- end -%>

[tls.options]
  [tls.options.defaultTlsOptions]
    minVersion = "<%= env_TRAEFIK_HTTPS_MIN_TLS %>"
<%- end -%>
#########################  /tls options/ ##########################

[entryPoints]
  [entryPoints.http]
    address = ":<%= env_TRAEFIK_HTTP_PORT %>"
    [entryPoints.http.transport]
    [entryPoints.http.transport.respondingTimeouts]
      readTimeout = "<%= env_TRAEFIK_TIMEOUT_READ %>s"
      writeTimeout = "<%= env_TRAEFIK_TIMEOUT_WRITE %>s"
      idleTimeout = "<%= env_TRAEFIK_TIMEOUT_IDLE %>s"
  <%- if env_TRAEFIK_HTTPS_ENABLE == "only" -%>
    [entryPoints.http.redirect]
      entryPoint = "https"
  <%- end -%>
  <%- if trusted_ips.length > 0 -%>
    [entryPoints.http.proxyProtocol]
      trustedIPs: <%= trusted_ips %>
    [entryPoints.http.forwardedHeaders]
      trustedIPs: <%= trusted_ips %>
  <%- end -%>

#########################  tls endpoint configuration ##########################
<% if %w(true only).include?(env_TRAEFIK_HTTPS_ENABLE) -%>
  # TLS endpoint
  [entryPoints.https]
    address = ":<%= env_TRAEFIK_HTTPS_PORT %>"
    compress = <%= env_TRAEFIK_HTTPS_COMPRESSION %>
    [entryPoints.https.transport]
    [entryPoints.https.transport.respondingTimeouts]
      readTimeout = "<%= env_TRAEFIK_TIMEOUT_READ %>s"
      writeTimeout = "<%= env_TRAEFIK_TIMEOUT_WRITE %>s"
      idleTimeout = "<%= env_TRAEFIK_TIMEOUT_IDLE %>s"
  <%- if trusted_ips.length > 0 -%>
    [entryPoints.https.proxyProtocol]
      trustedIPs: <%= trusted_ips %>
    [entryPoints.https.forwardedHeaders]
      trustedIPs: <%= trusted_ips %>
  <%- end -%>
<%-end -%>
#########################  /tls endpoint configuration/ ##########################

#########################  admin backend configuration ##########################
<%- if env_TRAEFIK_ADMIN_ENABLE == "true" -%>
  [entryPoints.traefik]
    address = ":<%= env_TRAEFIK_ADMIN_PORT %>"

[http.routers.my-api]
  rule="PathPrefix(`/api`) || PathPrefix(`/dashboard`)"
  service="api@internal"
  <%- if adminUsers.length > 0 -%>
  middlewares=["auth"]
  <% end -%>
  [http.routers.my-api.tls]
    options = "defaultTlsOptions"

[api]
  insecure = true
  dashboard = true
  debug = <%= env_TRAEFIK_DEBUG %>

[ping]
  entryPoint = "traefik"
<% end -%>
#########################  /admin backend configuration/ ##########################
#########################  acme ###########################
<%- if %w(true only).include?(env_TRAEFIK_HTTPS_ENABLE) && env_TRAEFIK_ACME_ENABLE == "true" -%>
[certificatesResolvers.default.acme]
  email = "<%= env_TRAEFIK_ACME_EMAIL %>"
  storage =  "<%= env_TRAEFIK_ACME_STORAGE %>"
  OnHostRule = <%= env_TRAEFIK_ACME_ONHOSTRULE %>
  caServer = "<%= env_TRAEFIK_ACME_CASERVER %>"
  entryPoint = "https"
  acmeLogging = <%= env_TRAEFIK_ACME_LOGGIN %>
  <%- if env_TRAEFIK_ACME_CHALLENGE == "http" -%>
  # HTTP-01
  [certificatesResolvers.default.acme.httpChallenge]
    entryPoint="http"
  <%- elsif env_TRAEFIK_ACME_CHALLENGE == "dns" -%>
  # DNS-01
  [certificatesResolvers.default.acme.dnsChallenge]
    provider = "<%= env_TRAEFIK_ACME_CHALLENGE_DNS_PROVIDER %>"
    delayBeforeCheck = <%= env_TRAEFIK_ACME_CHALLENGE_DNS_DELAY %>
  <%- end -%>
<%- end -%>
#########################  /acme/ #########################
#########################  rancher fronend/backend defintions  ##########################
[providers]
<%- if env_TRAEFIK_RANCHER_ENABLE == "true" -%>
  [providers.rancher]
    prefix = "<%= env_TRAEFIK_RANCHER_PREFIX%>"
    defaultRule = "<%= env_TRAEFIK_RANCHER_DEFAULT_RULE %>"
    refreshSeconds = <%= env_TRAEFIK_RANCHER_REFRESH %>
    exposedByDefault = <%= env_TRAEFIK_RANCHER_EXPOSED %>
    enableServiceHealthFilter = <%= env_TRAEFIK_RANCHER_HEALTHCHECK %>
    intervalPoll = <%= env_TRAEFIK_RANCHER_INTERVALPOLL%>
    <% if env_TRAEFIK_CONSTRAINTS != "" %>
    constraints = [ <%= env_TRAEFIK_CONSTRAINTS %> ]
    <% end -%>
<%- end -%>
#########################  /rancher fronend/backend defintions / ##########################
#########################  kubernetes fronend/backend defintions ##########################
<%- if env_TRAEFIK_K8S_ENABLE == "true" -%>
  [providers.kubernetes]
    constraints = [ <%= env_TRAEFIK_CONSTRAINTS %> ]
<%- end -%>
#########################  /kubernetes fronend/backend defintions/ ##########################
#########################  file base fronend/backend defintions ##########################
<% if env_TRAEFIK_FILE_ENABLE == "true" -%>
  [providers.file]
    directory = "<%= env_TRAEFIK_FILE_FOLDER %>"
    watch = true
<% end -%>
#########################  /file base fronend/backend defintions/ ##########################
#########################  docker based fronend/backend defintions ##########################
<% if env_TRAEFIK_DOCKER_ENABLE == "true" -%>
  [providers.docker]
    endpoint = "<%= env_TRAEFIK_DOCKER_ENDPOINT %>"
    defaultRule = "<%= env_TRAEFIK_DOCKER_DOMAIN || env_TRAEFIK_DOCKER_DEFAULT_RULE %>"
    exposedByDefault = <%= env_TRAEFIK_DOCKER_EXPOSEDBYDEFAULT %>
    swarmMode = <%= env_TRAEFIK_DOCKER_SWARMMODE %>
    constraints = [ <%= env_TRAEFIK_CONSTRAINTS %> ]
    <%- if env_TRAEFIK_DOCKER_TLS == "true" -%>
    [providers.docker.tls]
      ca = "/mnt/certs/docker.ca.crt"
      cert = "/mnt/certs/docker.crt"
      key = "/mnt/certs/docker.key"
      insecureSkipVerify = "<%= env_TRAEFIK_DOCKER_SKIP_VERIFY %>"
    <%- end -%>
<%- end -%>
#########################  /docker based fronend/backend defintions/ ##########################
#########################  metrics ##########################
<% if env_TRAEFIK_METRICS_ENABLE == "true" %>
[metrics]
  [metrics.statistics]
    RecentErrors = <%= env_TRAEFIK_ADMIN_STATISTICS %>
    <% if env_TRAEFIK_METRICS_EXPORTER == "prometheus" %>
    # prometheus metrics
    [metrics.<%= env_TRAEFIK_METRICS_EXPORTER %>]
      entryPoint = "traefik"
      buckets=<%= env_TRAEFIK_METRICS_PROMETHEUS_BUCKETS %>
    <% elsif env_TRAEFIK_METRICS_EXPORTER != "" %>
    # any other metric server
    [metrics.<%= env_TRAEFIK_METRICS_EXPORTER %>]Ã¥
      address = "<%= env_TRAEFIK_METRICS_ADDRESS %>"
      pushInterval = "<%= env_TRAEFIK_METRICS_PUSH %>s"
    <% end -%>
<% end -%>
#########################  /mentrics/ ##########################
